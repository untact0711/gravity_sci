<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>중력 낙하 시뮬레이션</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f0f4f8; /* Light blue-gray background */
            padding: 20px;
            box-sizing: border-box;
        }
        canvas {
            background-color: #ffffff; /* White canvas background */
            border: 2px solid #cbd5e1; /* Light gray border */
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: block;
            touch-action: none; /* Disable default touch actions like scrolling */
        }
        .controls, .info-display, .explanations, .llm-explanation {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-top: 20px;
            width: 100%;
            max-width: 600px;
        }
        .controls label {
            font-weight: 600;
            color: #4a5568; /* Dark gray text */
        }
        .controls input[type="range"], .controls input[type="number"] {
            width: calc(100% - 100px); /* Adjust width for number input */
            margin-left: 10px;
            accent-color: #4299e1; /* Blue accent color for range slider */
        }
        .controls button {
            background-color: #4299e1; /* Blue button */
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            margin-top: 10px; /* Space between buttons */
        }
        .controls button:hover {
            background-color: #3182ce; /* Darker blue on hover */
        }
        .info-display p {
            font-size: 1.1em;
            color: #2d3748; /* Darker text for info */
            margin-bottom: 8px;
        }
        .explanations h3, .llm-explanation h3 {
            font-size: 1.4em;
            font-weight: 700;
            color: #2c5282; /* Dark blue for headings */
            margin-bottom: 10px;
        }
        .explanations p, .llm-explanation p {
            margin-bottom: 12px;
            line-height: 1.6;
            color: #4a5568;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .ball-controls-group {
            border: 1px solid #e2e8f0; /* Light border for groups */
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f8fafc; /* Slightly different background for groups */
        }
        .ball-controls-group h3 {
            font-size: 1.2em;
            font-weight: 700;
            color: #2c5282;
            margin-bottom: 15px;
            text-align: center;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-5">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">중력 낙하 시뮬레이션</h1>

    <canvas id="physicsCanvas" width="400" height="600"></canvas>

    <div class="controls w-full max-w-xl mt-6 p-6 bg-white rounded-xl shadow-lg">
        <!-- Global Air Resistance -->
        <div class="mb-4">
            <label for="airResistance" class="block text-gray-700 text-sm font-bold mb-2">공기 저항 계수:</label>
            <div class="flex items-center">
                <input type="range" id="airResistance" min="0" max="0.1" value="0.01" step="0.001" class="flex-grow mr-3">
                <input type="number" id="airResistanceNumber" min="0" max="0.1" value="0.01" step="0.001" class="w-20 p-2 border border-gray-300 rounded-md text-center">
            </div>
        </div>

        <!-- Ball 1 Controls -->
        <div class="ball-controls-group">
            <h3>공 1 (빨간색)</h3>
            <div class="mb-4">
                <label for="ball1Mass" class="block text-gray-700 text-sm font-bold mb-2">질량 (kg):</label>
                <div class="flex items-center">
                    <input type="range" id="ball1Mass" min="0.1" max="10" value="1" step="0.1" class="flex-grow mr-3">
                    <input type="number" id="ball1MassNumber" min="0.1" max="10" value="1" step="0.1" class="w-20 p-2 border border-gray-300 rounded-md text-center">
                </div>
            </div>
            <div class="mb-6">
                <label for="ball1Gravity" class="block text-gray-700 text-sm font-bold mb-2">중력 가속도 ($m/s^2$):</label>
                <div class="flex items-center">
                    <input type="range" id="ball1Gravity" min="1" max="20" value="9.81" step="0.1" class="flex-grow mr-3">
                    <input type="number" id="ball1GravityNumber" min="1" max="20" value="9.81" step="0.1" class="w-20 p-2 border border-gray-300 rounded-md text-center">
                </div>
            </div>
        </div>

        <!-- Ball 2 Controls -->
        <div class="ball-controls-group">
            <h3>공 2 (파란색)</h3>
            <div class="mb-4">
                <label for="ball2Mass" class="block text-gray-700 text-sm font-bold mb-2">질량 (kg):</label>
                <div class="flex items-center">
                    <input type="range" id="ball2Mass" min="0.1" max="10" value="1" step="0.1" class="flex-grow mr-3">
                    <input type="number" id="ball2MassNumber" min="0.1" max="10" value="1" step="0.1" class="w-20 p-2 border border-gray-300 rounded-md text-center">
                </div>
            </div>
            <div class="mb-6">
                <label for="ball2Gravity" class="block text-gray-700 text-sm font-bold mb-2">중력 가속도 ($m/s^2$):</label>
                <div class="flex items-center">
                    <input type="range" id="ball2Gravity" min="1" max="20" value="9.81" step="0.1" class="flex-grow mr-3">
                    <input type="number" id="ball2GravityNumber" min="1" max="20" value="9.81" step="0.1" class="w-20 p-2 border border-gray-300 rounded-md text-center">
                </div>
            </div>
        </div>
        
        <button id="startResetButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out">
            시뮬레이션 시작 / 재설정
        </button>
        <button id="generateExplanationButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out mt-3">
            ✨ 시뮬레이션 설명 생성 ✨
        </button>
    </div>

    <div class="info-display w-full max-w-xl mt-6 p-6 bg-white rounded-xl shadow-lg">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">현재 상태</h2>
        <p>공 1 속도: <span id="ball1Velocity">0.00</span> $m/s$</p>
        <p>공 1 가속도: <span id="ball1Acceleration">0.00</span> $m/s^2$</p>
        <p>공 2 속도: <span id="ball2Velocity">0.00</span> $m/s$</p>
        <p>공 2 가속도: <span id="ball2Acceleration">0.00</span> $m/s^2$</p>
    </div>

    <div class="explanations w-full max-w-xl mt-6 p-6 bg-white rounded-xl shadow-lg">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">각 요소의 역할</h2>
        <h3 class="text-xl font-semibold text-blue-700 mb-2">공의 질량 ($m$)</h3>
        <p>질량은 물체가 가지고 있는 물질의 양을 나타냅니다. 이 시뮬레이션에서는 질량이 클수록 공기 저항의 영향이 상대적으로 줄어들어 더 빠르게 가속될 수 있습니다. 뉴턴의 제2법칙 ($F=ma$)에 따르면, 동일한 힘이 가해질 때 질량이 클수록 가속도는 작아지지만, 중력 ($F_g = mg$)도 질량에 비례하여 증가하므로, 공기 저항이 없다면 모든 물체는 질량과 관계없이 동일한 중력 가속도로 떨어집니다. 하지만 공기 저항이 있을 경우, 질량이 큰 물체는 공기 저항의 영향을 덜 받아 더 빠르게 떨어지는 경향이 있습니다.</p>

        <h3 class="text-xl font-semibold text-blue-700 mb-2">공기 저항 계수 ($k$)</h3>
        <p>공기 저항은 물체가 공기 중에서 움직일 때 받는 저항력입니다. 이 시뮬레이션에서는 속도의 제곱에 비례하는 저항력 ($F_{air} = -k \cdot v^2$)으로 모델링됩니다. 공기 저항 계수가 높을수록 공은 더 큰 저항을 받아 속도 증가가 억제되고, 종단 속도에 더 빨리 도달하거나 더 낮은 종단 속도를 가집니다. 종단 속도는 중력과 공기 저항이 균형을 이루어 더 이상 가속되지 않는 속도를 의미합니다.</p>

        <h3 class="text-xl font-semibold text-blue-700 mb-2">중력 가속도 ($g$)</h3>
        <p>중력 가속도는 중력에 의해 물체가 자유 낙하할 때 얻는 가속도입니다. 지구에서는 약 $9.81 \, m/s^2$입니다. 이 값이 높을수록 공은 더 강한 중력의 영향을 받아 더 빠르게 가속되고, 더 높은 속도에 도달합니다. 다른 행성이나 환경에서의 중력을 시뮬레이션하기 위해 이 값을 조정할 수 있습니다.</p>
    </div>

    <div id="llmExplanationContainer" class="llm-explanation w-full max-w-xl mt-6 p-6 bg-white rounded-xl shadow-lg hidden">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">✨ 시뮬레이션 설명 ✨</h2>
        <div id="llmExplanationContent">
            <!-- LLM generated explanation will be displayed here -->
        </div>
    </div>

    <script>
        const canvas = document.getElementById('physicsCanvas');
        const ctx = canvas.getContext('2d');

        // Control elements for Ball 1
        const ball1MassInput = document.getElementById('ball1Mass');
        const ball1MassNumberInput = document.getElementById('ball1MassNumber');
        const ball1GravityInput = document.getElementById('ball1Gravity');
        const ball1GravityNumberInput = document.getElementById('ball1GravityNumber');

        // Control elements for Ball 2
        const ball2MassInput = document.getElementById('ball2Mass');
        const ball2MassNumberInput = document.getElementById('ball2MassNumber');
        const ball2GravityInput = document.getElementById('ball2Gravity');
        const ball2GravityNumberInput = document.getElementById('ball2GravityNumber');

        // Global Air Resistance control
        const airResistanceInput = document.getElementById('airResistance');
        const airResistanceNumberInput = document.getElementById('airResistanceNumber');
        
        const startResetButton = document.getElementById('startResetButton');
        const generateExplanationButton = document.getElementById('generateExplanationButton');

        // Display elements
        const ball1VelocitySpan = document.getElementById('ball1Velocity');
        const ball1AccelerationSpan = document.getElementById('ball1Acceleration');
        const ball2VelocitySpan = document.getElementById('ball2Velocity');
        const ball2AccelerationSpan = document.getElementById('ball2Acceleration');
        
        const llmExplanationContainer = document.getElementById('llmExplanationContainer');
        const llmExplanationContent = document.getElementById('llmExplanationContent');

        // Simulation parameters
        let airResistanceCoefficient = parseFloat(airResistanceInput.value); // k in F_air = -k * v^2
        const speedMultiplier = 2; // Multiplier to speed up the simulation visually

        // Ball 1 properties (now an object)
        let ball1 = {
            radius: 20, // pixels
            x: canvas.width / 4, // Start left
            y: 20, // Start at the top
            mass: parseFloat(ball1MassInput.value), // kg
            gravity: parseFloat(ball1GravityInput.value), // m/s^2
            velocityY: 0, // m/s (downwards positive)
            accelerationY: 0 // m/s^2 (downwards positive)
        };

        // Ball 2 properties (now an object)
        let ball2 = {
            radius: 20, // pixels
            x: canvas.width * 3 / 4, // Start right
            y: 20, // Start at the top
            mass: parseFloat(ball2MassInput.value), // kg
            gravity: parseFloat(ball2GravityInput.value), // m/s^2
            velocityY: 0, // m/s (downwards positive)
            accelerationY: 0 // m/s^2 (downwards positive)
        };

        let lastTime;
        let animationFrameId;
        let isRunning = false;

        // Function to initialize or reset the simulation
        function initSimulation() {
            cancelAnimationFrame(animationFrameId); // Stop any existing animation

            // Reset Ball 1 properties
            ball1.x = canvas.width / 4;
            ball1.y = ball1.radius;
            ball1.velocityY = 0;
            ball1.accelerationY = 0;
            ball1.mass = parseFloat(ball1MassInput.value); // Reset mass from input
            ball1.gravity = parseFloat(ball1GravityInput.value); // Reset gravity from input

            // Reset Ball 2 properties
            ball2.x = canvas.width * 3 / 4;
            ball2.y = ball2.radius;
            ball2.velocityY = 0;
            ball2.accelerationY = 0;
            ball2.mass = parseFloat(ball2MassInput.value); // Reset mass from input
            ball2.gravity = parseFloat(ball2GravityInput.value); // Reset gravity from input

            airResistanceCoefficient = parseFloat(airResistanceInput.value); // Reset global air resistance

            lastTime = null;
            isRunning = false;
            drawBalls(); // Draw initial state
            updateDisplay();
            startResetButton.textContent = '시뮬레이션 시작 / 재설정';
            llmExplanationContainer.classList.add('hidden'); // Hide explanation on reset
            llmExplanationContent.innerHTML = ''; // Clear explanation content
        }

        // Function to draw both balls
        function drawBalls() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas

            // Draw Ball 1 (Red)
            ctx.beginPath();
            ctx.arc(ball1.x, ball1.y, ball1.radius, 0, Math.PI * 2);
            ctx.fillStyle = '#ef4444'; // Red ball
            ctx.fill();
            ctx.strokeStyle = '#b91c1c'; // Darker red border
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.closePath();

            // Draw Ball 2 (Blue)
            ctx.beginPath();
            ctx.arc(ball2.x, ball2.y, ball2.radius, 0, Math.PI * 2);
            ctx.fillStyle = '#3b82f6'; // Blue ball
            ctx.fill();
            ctx.strokeStyle = '#1d4ed8'; // Darker blue border
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.closePath();
        }

        // Function to update physics for a single ball
        function updateBallPhysics(ball, dt) {
            // Calculate forces
            const gravitationalForce = ball.mass * ball.gravity; // F_g = m * g
            const airResistanceForce = -airResistanceCoefficient * ball.velocityY * Math.abs(ball.velocityY);

            // Net force (downwards positive)
            const netForce = gravitationalForce + airResistanceForce;

            // Acceleration (a = F_net / m)
            ball.accelerationY = netForce / ball.mass;

            // Update velocity
            ball.velocityY += ball.accelerationY * dt;

            // Update position
            ball.y += ball.velocityY * dt;

            // Collision with ground
            if (ball.y + ball.radius > canvas.height) {
                ball.y = canvas.height - ball.radius; // Place ball on ground
                ball.velocityY *= -0.7; // Bounce with energy loss (70% restitution)
                if (Math.abs(ball.velocityY) < 0.1) { // Stop if velocity is very small
                    ball.velocityY = 0;
                    ball.accelerationY = 0;
                    return false; // Indicate ball has stopped
                }
            }

            // Prevent ball from going above the top
            if (ball.y - ball.radius < 0 && ball.velocityY < 0) {
                ball.y = ball.radius;
                ball.velocityY = 0;
                ball.accelerationY = 0;
            }
            return true; // Indicate ball is still moving
        }

        // Main animation loop
        function gameLoop(currentTime) {
            if (!lastTime) {
                lastTime = currentTime;
            }
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;

            if (isRunning) {
                // Convert deltaTime from milliseconds to seconds and apply speed multiplier
                const dt = (deltaTime / 1000) * speedMultiplier;

                // Update physics for Ball 1
                const ball1StillMoving = updateBallPhysics(ball1, dt);

                // Update physics for Ball 2
                const ball2StillMoving = updateBallPhysics(ball2, dt);

                drawBalls();
                updateDisplay();

                // Stop simulation if both balls have stopped
                if (!ball1StillMoving && !ball2StillMoving) {
                    isRunning = false;
                    startResetButton.textContent = '시뮬레이션 시작 / 재설정';
                }
            }

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // Function to update display values
        function updateDisplay() {
            ball1VelocitySpan.textContent = ball1.velocityY.toFixed(2);
            ball1AccelerationSpan.textContent = ball1.accelerationY.toFixed(2);
            ball2VelocitySpan.textContent = ball2.velocityY.toFixed(2);
            ball2AccelerationSpan.textContent = ball2.accelerationY.toFixed(2);
        }

        // Function to generate explanation using Gemini API
        async function generateExplanation() {
            llmExplanationContainer.classList.remove('hidden');
            llmExplanationContent.innerHTML = '<div class="loading-spinner"></div> 설명 생성 중...'; // Show loading

            const prompt = `You are a physics expert. Explain the simultaneous fall of two balls.
            Ball 1 (red) has a mass of ${ball1.mass.toFixed(2)} kg and a gravitational acceleration of ${ball1.gravity.toFixed(2)} m/s^2. Its current velocity is ${ball1.velocityY.toFixed(2)} m/s and acceleration is ${ball1.accelerationY.toFixed(2)} m/s^2.
            Ball 2 (blue) has a mass of ${ball2.mass.toFixed(2)} kg and a gravitational acceleration of ${ball2.gravity.toFixed(2)} m/s^2. Its current velocity is ${ball2.velocityY.toFixed(2)} m/s and acceleration is ${ball2.accelerationY.toFixed(2)} m/s^2.
            The global air resistance coefficient is ${airResistanceCoefficient.toFixed(3)}.
            Focus on the interplay between these parameters for both balls and how their individual settings affect their descent relative to each other. Keep the explanation concise and easy to understand for a general audience. Use Korean.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = { contents: chatHistory };
            const apiKey = ""; // Canvas will provide this at runtime
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    llmExplanationContent.innerHTML = `<p>${text}</p>`;
                } else {
                    llmExplanationContent.innerHTML = '<p>설명을 생성하는 데 실패했습니다. 다시 시도해 주세요.</p>';
                    console.error('Gemini API response structure unexpected:', result);
                }
            } catch (error) {
                llmExplanationContent.innerHTML = '<p>설명을 생성하는 중 오류가 발생했습니다. 네트워크 연결을 확인하거나 나중에 다시 시도해 주세요.</p>';
                console.error('Error calling Gemini API:', error);
            }
        }

        // Event listeners for input changes - Ball 1
        ball1MassInput.addEventListener('input', () => {
            ball1MassNumberInput.value = ball1MassInput.value;
            ball1.mass = parseFloat(ball1MassInput.value); // Update ball1 object
            if (!isRunning) drawBalls();
        });
        ball1MassNumberInput.addEventListener('change', () => {
            ball1MassInput.value = ball1MassNumberInput.value;
            ball1.mass = parseFloat(ball1MassNumberInput.value); // Update ball1 object
            if (!isRunning) drawBalls();
        });

        ball1GravityInput.addEventListener('input', () => {
            ball1GravityNumberInput.value = ball1GravityInput.value;
            ball1.gravity = parseFloat(ball1GravityInput.value); // Update ball1 object
            if (!isRunning) drawBalls();
        });
        ball1GravityNumberInput.addEventListener('change', () => {
            ball1GravityInput.value = ball1GravityNumberInput.value;
            ball1.gravity = parseFloat(ball1GravityNumberInput.value); // Update ball1 object
            if (!isRunning) drawBalls();
        });

        // Event listeners for input changes - Ball 2
        ball2MassInput.addEventListener('input', () => {
            ball2MassNumberInput.value = ball2MassInput.value;
            ball2.mass = parseFloat(ball2MassInput.value); // Update ball2 object
            if (!isRunning) drawBalls();
        });
        ball2MassNumberInput.addEventListener('change', () => {
            ball2MassInput.value = ball2MassNumberInput.value;
            ball2.mass = parseFloat(ball2MassNumberInput.value); // Update ball2 object
            if (!isRunning) drawBalls();
        });

        ball2GravityInput.addEventListener('input', () => {
            ball2GravityNumberInput.value = ball2GravityInput.value;
            ball2.gravity = parseFloat(ball2GravityInput.value); // Update ball2 object
            if (!isRunning) drawBalls();
        });
        ball2GravityNumberInput.addEventListener('change', () => {
            ball2GravityInput.value = ball2GravityNumberInput.value;
            ball2.gravity = parseFloat(ball2GravityNumberInput.value); // Update ball2 object
            if (!isRunning) drawBalls();
        });

        // Event listeners for global air resistance
        airResistanceInput.addEventListener('input', () => {
            airResistanceNumberInput.value = airResistanceInput.value;
            airResistanceCoefficient = parseFloat(airResistanceInput.value);
            if (!isRunning) drawBalls();
        });
        airResistanceNumberInput.addEventListener('change', () => {
            airResistanceInput.value = airResistanceNumberInput.value;
            airResistanceCoefficient = parseFloat(airResistanceNumberInput.value);
            if (!isRunning) drawBalls();
        });

        // Event listener for start/reset button
        startResetButton.addEventListener('click', () => {
            if (isRunning) {
                initSimulation(); // Reset if running
            } else {
                // Update parameters from inputs before starting
                ball1.mass = parseFloat(ball1MassInput.value);
                ball1.gravity = parseFloat(ball1GravityInput.value);
                ball2.mass = parseFloat(ball2MassInput.value);
                ball2.gravity = parseFloat(ball2GravityInput.value);
                airResistanceCoefficient = parseFloat(airResistanceInput.value);

                // Reset velocities and accelerations
                ball1.velocityY = 0;
                ball1.accelerationY = 0;
                ball2.velocityY = 0;
                ball2.accelerationY = 0;
                
                lastTime = null; // Reset lastTime for accurate deltaTime
                isRunning = true;
                startResetButton.textContent = '재설정';
                animationFrameId = requestAnimationFrame(gameLoop); // Start the loop
            }
        });

        // Event listener for generate explanation button
        generateExplanationButton.addEventListener('click', generateExplanation);


        // Initial setup when the window loads
        window.onload = function() {
            initSimulation();
            animationFrameId = requestAnimationFrame(gameLoop); // Start the loop for initial display
        };
    </script>
</body>
</html>
